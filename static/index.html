<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Cher</title>
        <link rel="stylesheet" type="text/css" href="styles.css">
        <script src="/plotly/plotly.min.js"></script>
        <script>
            let ws;
            let running = false;

            document.addEventListener('DOMContentLoaded', () => {
                const lossElement = document.getElementById('loss');
                const stepTimeElement = document.getElementById('step_time');
                const strikeInputElement = document.getElementById('strike');
                const testPathPlotElement = document.getElementById('test_path_plot');

                const plotlyLayout = {
                    legend: {
                        font: { color: '#dddddd' }
                    },
                    margin: { t: 40, b: 40, l: 40, r: 40 },
                    xaxis: {
                        range: [1, 0],
                        autorange: false,
                        tickfont: { color: '#dddddd' },
                        gridcolor: '#555555',
                        zerolinecolor: '#dddddd',
                    },
                    yaxis: {
                        range: [0, 2],
                        autorange: false,
                        tickfont: { color: '#dddddd' },
                        gridcolor: '#555555',
                        zerolinecolor: '#dddddd',
                    },
                    yaxis2: {
                        range: [-1, 1],
                        autorange: false,
                        overlaying: 'y',
                        side: 'right',
                        gridcolor: 'rgba(0,0,0,0)',
                        tickfont: { color: '#dddddd' },
                    },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                };

                const plotlyConfig = {
                    responsive: true,
                };

                var strikeTrace = {
                    name: 'strike',
                    x: [1, 0],
                    y: [0, 0],
                    mode: 'lines',
                    line: { color: '#f38ba8' },
                };
                var testPathTraces = []

                Plotly.newPlot(
                    testPathPlotElement, 
                    [strikeTrace], 
                    plotlyLayout, 
                    plotlyConfig,
                );

                ws = new WebSocket('/ws');

                document.getElementById('parameters_form').addEventListener('input', function(event) {
                    const element = event.target;
                    const name = element.name;
                    const dataType = element.getAttribute('data-type');
                    let value = element.value;

                    if (dataType == 'int') {
                        value = parseInt(value, 10);
                    } else if (dataType == 'float') {
                        value = parseFloat(value);
                    }

                    if (name == 'strike') {
                        strikeTrace.y = [value, value];
                        Plotly.react(testPathPlotElement, [strikeTrace, ...testPathTraces], plotlyLayout);
                    }

                    if (ws && ws.readyState === WebSocket.OPEN) {
                        const jsonData = {};
                        jsonData[name] = value;
                        ws.send(JSON.stringify(jsonData));
                    }
                });

                ws.onopen = () => console.log('websocket connected');
                ws.onclose = () => console.log('websocket closed');
                ws.onmessage = (event) => {
                    data = JSON.parse(event.data)
                    if ('params' in data) {
                        const params = data.params;
                        for (const [key, value] of Object.entries(params)) {
                            const element = document.getElementById(key);
                            if (element) {
                                element.value = value;
                            }
                        }
                        // Update strike trace with new value
                        strikeTrace.y = [params.strike, params.strike];
                        Plotly.react(testPathPlotElement, [strikeTrace], plotlyLayout);
                    }
                    if ('loss' in data) {
                        lossElement.textContent = data.loss;
                    }
                    if ('avg_step_time' in data) {
                        stepTimeElement.textContent = formatTime(data.avg_step_time);
                    }
                    if ('test_path' in data) {
                        testPathTraces = [
                            {
                                name: 'test path',
                                x: data.test_path.t,
                                y: data.test_path.s,
                                mode: 'lines',
                                line: {color: '#89b4fa'}
                            },
                            {
                                name: 'hedge',
                                x: data.test_path.t,
                                y: data.test_path.d,
                                yaxis: 'y2',
                                mode: 'lines',
                                line: {color: '#fab387'}
                            },
                        ]

                        Plotly.react(
                            testPathPlotElement, 
                            [strikeTrace, ...testPathTraces],
                            plotlyLayout,
                        )
                    }
                };
            });

            function formatTime(seconds) {
                if (seconds >= 1) {
                    return seconds.toFixed(3) + ' s';
                } else if (seconds >= 1e-3) {
                    return (seconds * 1e3).toFixed(3) + ' ms';
                } else if (seconds >= 1e-6) {
                    return (seconds * 1e6).toFixed(3) + ' \u00B5s';
                } else {
                    return (seconds * 1e9).toFixed(3) + ' ns';
                }
            }

            function formDataAsJson() {
                const formData = new FormData(document.getElementById('parameters_form'));
                const jsonData = {};

                formData.forEach((v, k) => {
                    element = document.querySelector(`[name="${k}"]`);
                    dataType = element.getAttribute('data-type');
                    if (dataType == 'int') {
                        jsonData[k] = parseInt(v, 10)
                    } else if (dataType == 'float') {
                        jsonData[k] = parseFloat(v)
                    } else {
                        jsonData[k] = v
                    }
                });

                return jsonData;
            }

            function toggleRunning() {
                const button = document.getElementById('control_button');

                if (running) {
                    button.value = 'start';
                    running = false;
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        const message = JSON.stringify({
                            'event': 'stop',
                        });
                        ws.send(message);
                    }
                } else {
                    button.value = 'stop';
                    running = true;
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        const message = JSON.stringify({
                            'event': 'start',
                        });
                        ws.send(message);
                    }
                }
            }
            function generatePath() {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    const message = JSON.stringify({
                        'event': 'generate_path',
                    });
                    ws.send(message);
                }
            }
        </script>
    </head>
    <body>
        <div class="container">
            <div class="card">
                <form id="parameters_form" name="parameters_form" class="parameters-form">

                    <label for="inputs">
                        inputs:
                    </label>
                    <input type="number"
                           id="inputs"
                           name="inputs"
                           step="1"
                           data-type="int"
                    />

                    <label for="network_size">
                        network size:
                    </label>
                    <input type="number"
                           id="network_size"
                           name="network_size"
                           step="1"
                           data-type="int"
                    />

                    <label for="steps">
                        steps
                    </label>
                    <input type="number"
                           id="steps"
                           name="steps"
                           step="1"
                           data-type="int"
                    />

                    <label for="paths">
                        paths
                    </label>
                    <input type="number"
                           id="paths"
                           name="paths"
                           step="1"
                           data-type="int"
                    />

                    <label for="lr">
                        learning rate
                    </label>
                    <input type="number"
                           id="lr"
                           name="lr"
                           step="1e-6"
                           data-type="float"
                    />

                    <label for="lr_d1">
                        learning rate decay 1
                    </label>
                    <input type="number"
                           id="lr_d1"
                           name="lr_d1"
                           step="0.01"
                           data-type="float"
                    />

                    <label for="lr_d2">
                        learning rate decay 2
                    </label>
                    <input type="number"
                           id="lr_d2"
                           name="lr_d2"
                           step="1"
                           data-type="float"
                    />

                    <label for="beta1">
                        beta 1
                    </label>
                    <input type="number"
                           id="beta1"
                           name="beta1"
                           step="1e-4"
                           data-type="float"
                    />

                    <label for="beta2">
                        beta 2
                    </label>
                    <input type="number"
                           id="beta2"
                           name="beta2"
                           step="1e-4"
                           data-type="float"
                    />

                    <label for="eps">
                        eps
                    </label>
                    <input type="number"
                           id="eps"
                           name="eps"
                           step="1e-12"
                           data-type="float"
                    />

                    <label for="weight_decay">
                        weight decay
                    </label>
                    <input type="number"
                           id="weight_decay"
                           name="weight_decay"
                           step="1e-4"
                           data-type="float"
                    />

                    <label for="drift">
                        drift
                    </label>
                    <input type="number"
                           id="drift"
                           name="drift"
                           step="1e-4"
                           data-type="float"
                    />

                    <label for="vol">
                        vol
                    </label>
                    <input type="number"
                           id="vol"
                           name="vol"
                           step="0.01"
                           data-type="float"
                    />

                    <label for="strike">
                        strike
                    </label>
                    <input type="number"
                           id="strike"
                           name="strike"
                           step="0.01"
                           data-type="float"
                    />

                    <label for="slippage">
                        slippage
                    </label>
                    <input type="number"
                           id="slippage"
                           name="slippage"
                           step="1e-4"
                           data-type="float"
                    />

                    <label for="seed">
                        seed
                    </label>
                    <input type="number"
                           id="seed"
                           name="seed"
                           step="1"
                           data-type="int"
                    />

                    <input type="button" 
                           id="control_button" 
                           name="control_button" 
                           value="start"
                           onClick="toggleRunning()"
                    />
                </form>
            </div>
            <div class="card">
                <div class="m-04">loss: <span id="loss"></span></div>
                <div class="m-04">step: <span id="step_time"></span></div>
                <div class="m-04">
                    <input type="button" 
                           id="generate_path_button" 
                           name="generate_path_button" 
                           value="regenerate path"
                           onClick="generatePath()"
                    />
                </div>
                <div class="m-04" id="test_path_plot"></div>
            </div>
        </div>
    </body>
</html>
